/*! For license information please see background.js.LICENSE.txt */
(()=>{"use strict";function e(r){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(r)}function r(){r=function(){return t};var n,t={},o=Object.prototype,s=o.hasOwnProperty,c=Object.defineProperty||function(e,r,n){e[r]=n.value},a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",u=a.asyncIterator||"@@asyncIterator",l=a.toStringTag||"@@toStringTag";function d(e,r,n){return Object.defineProperty(e,r,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[r]}try{d({},"")}catch(n){d=function(e,r,n){return e[r]=n}}function g(e,r,n,t){var o=r&&r.prototype instanceof _?r:_,s=Object.create(o.prototype),a=new N(t||[]);return c(s,"_invoke",{value:v(e,n,a)}),s}function m(e,r,n){try{return{type:"normal",arg:e.call(r,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=g;var h="suspendedStart",p="suspendedYield",f="executing",R="completed",E={};function _(){}function b(){}function T(){}var O={};d(O,i,(function(){return this}));var y=Object.getPrototypeOf,M=y&&y(y(w([])));M&&M!==o&&s.call(M,i)&&(O=M);var A=T.prototype=_.prototype=Object.create(O);function S(e){["next","throw","return"].forEach((function(r){d(e,r,(function(e){return this._invoke(r,e)}))}))}function D(r,n){function t(o,c,a,i){var u=m(r[o],r,c);if("throw"!==u.type){var l=u.arg,d=l.value;return d&&"object"==e(d)&&s.call(d,"__await")?n.resolve(d.__await).then((function(e){t("next",e,a,i)}),(function(e){t("throw",e,a,i)})):n.resolve(d).then((function(e){l.value=e,a(l)}),(function(e){return t("throw",e,a,i)}))}i(u.arg)}var o;c(this,"_invoke",{value:function(e,r){function s(){return new n((function(n,o){t(e,r,n,o)}))}return o=o?o.then(s,s):s()}})}function v(e,r,t){var o=h;return function(s,c){if(o===f)throw Error("Generator is already running");if(o===R){if("throw"===s)throw c;return{value:n,done:!0}}for(t.method=s,t.arg=c;;){var a=t.delegate;if(a){var i=C(a,t);if(i){if(i===E)continue;return i}}if("next"===t.method)t.sent=t._sent=t.arg;else if("throw"===t.method){if(o===h)throw o=R,t.arg;t.dispatchException(t.arg)}else"return"===t.method&&t.abrupt("return",t.arg);o=f;var u=m(e,r,t);if("normal"===u.type){if(o=t.done?R:p,u.arg===E)continue;return{value:u.arg,done:t.done}}"throw"===u.type&&(o=R,t.method="throw",t.arg=u.arg)}}}function C(e,r){var t=r.method,o=e.iterator[t];if(o===n)return r.delegate=null,"throw"===t&&e.iterator.return&&(r.method="return",r.arg=n,C(e,r),"throw"===r.method)||"return"!==t&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+t+"' method")),E;var s=m(o,e.iterator,r.arg);if("throw"===s.type)return r.method="throw",r.arg=s.arg,r.delegate=null,E;var c=s.arg;return c?c.done?(r[e.resultName]=c.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=n),r.delegate=null,E):c:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,E)}function L(e){var r={tryLoc:e[0]};1 in e&&(r.catchLoc=e[1]),2 in e&&(r.finallyLoc=e[2],r.afterLoc=e[3]),this.tryEntries.push(r)}function k(e){var r=e.completion||{};r.type="normal",delete r.arg,e.completion=r}function N(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(L,this),this.reset(!0)}function w(r){if(r||""===r){var t=r[i];if(t)return t.call(r);if("function"==typeof r.next)return r;if(!isNaN(r.length)){var o=-1,c=function e(){for(;++o<r.length;)if(s.call(r,o))return e.value=r[o],e.done=!1,e;return e.value=n,e.done=!0,e};return c.next=c}}throw new TypeError(e(r)+" is not iterable")}return b.prototype=T,c(A,"constructor",{value:T,configurable:!0}),c(T,"constructor",{value:b,configurable:!0}),b.displayName=d(T,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var r="function"==typeof e&&e.constructor;return!!r&&(r===b||"GeneratorFunction"===(r.displayName||r.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,T):(e.__proto__=T,d(e,l,"GeneratorFunction")),e.prototype=Object.create(A),e},t.awrap=function(e){return{__await:e}},S(D.prototype),d(D.prototype,u,(function(){return this})),t.AsyncIterator=D,t.async=function(e,r,n,o,s){void 0===s&&(s=Promise);var c=new D(g(e,r,n,o),s);return t.isGeneratorFunction(r)?c:c.next().then((function(e){return e.done?e.value:c.next()}))},S(A),d(A,l,"Generator"),d(A,i,(function(){return this})),d(A,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var r=Object(e),n=[];for(var t in r)n.push(t);return n.reverse(),function e(){for(;n.length;){var t=n.pop();if(t in r)return e.value=t,e.done=!1,e}return e.done=!0,e}},t.values=w,N.prototype={constructor:N,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=n,this.done=!1,this.delegate=null,this.method="next",this.arg=n,this.tryEntries.forEach(k),!e)for(var r in this)"t"===r.charAt(0)&&s.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=n)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function t(t,o){return a.type="throw",a.arg=e,r.next=t,o&&(r.method="next",r.arg=n),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var c=this.tryEntries[o],a=c.completion;if("root"===c.tryLoc)return t("end");if(c.tryLoc<=this.prev){var i=s.call(c,"catchLoc"),u=s.call(c,"finallyLoc");if(i&&u){if(this.prev<c.catchLoc)return t(c.catchLoc,!0);if(this.prev<c.finallyLoc)return t(c.finallyLoc)}else if(i){if(this.prev<c.catchLoc)return t(c.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<c.finallyLoc)return t(c.finallyLoc)}}}},abrupt:function(e,r){for(var n=this.tryEntries.length-1;n>=0;--n){var t=this.tryEntries[n];if(t.tryLoc<=this.prev&&s.call(t,"finallyLoc")&&this.prev<t.finallyLoc){var o=t;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=r&&r<=o.finallyLoc&&(o=null);var c=o?o.completion:{};return c.type=e,c.arg=r,o?(this.method="next",this.next=o.finallyLoc,E):this.complete(c)},complete:function(e,r){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&r&&(this.next=r),E},finish:function(e){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),k(n),E}},catch:function(e){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.tryLoc===e){var t=n.completion;if("throw"===t.type){var o=t.arg;k(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(e,r,t){return this.delegate={iterator:w(e),resultName:r,nextLoc:t},"next"===this.method&&(this.arg=n),E}},t}function n(e,r,n,t,o,s,c){try{var a=e[s](c),i=a.value}catch(e){return void n(e)}a.done?r(i):Promise.resolve(i).then(t,o)}function t(e){return function(){var r=this,t=arguments;return new Promise((function(o,s){var c=e.apply(r,t);function a(e){n(c,o,s,a,i,"next",e)}function i(e){n(c,o,s,a,i,"throw",e)}a(void 0)}))}}var o=0;chrome.runtime.onInstalled.addListener((function(){chrome.storage.local.get(["displayType"],(function(e){e.displayType||chrome.storage.local.set({displayType:"sidebar"})}))})),chrome.action.onClicked.addListener((function(e){console.log("Extension clicked","Tab ID: ".concat(e.id,", Window ID: ").concat(e.windowId)),chrome.storage.local.get(["displayType"],(function(r){"sidebar"===(r.displayType||"sidebar")?chrome.sidePanel.open({windowId:e.windowId}):(chrome.action.setPopup({popup:"popup.html"}),chrome.windows.create({url:"popup.html",type:"popup",width:700,height:600}))}))})),chrome.action.setPopup({popup:""}),chrome.runtime.onConnect.addListener((function(e){"sidepanel"===e.name&&(o=1,e.onDisconnect.addListener((function(){o=0})))})),chrome.runtime.onMessage.addListener((function(e,r){if("toggle_sidebar"===e.action)return chrome.storage.local.get("displayType",(function(e){"sidebar"!==e.displayType||o?"sidebar"===e.displayType&&(chrome.sidePanel.setOptions({enabled:!1}),o=0,chrome.sidePanel.setOptions({enabled:!0,path:"sidebar.html"})):(chrome.sidePanel.open({windowId:r.tab.windowId}),o=1)})),!0})),chrome.runtime.onMessage.addListener((function(e){"MICROPHONE_ACTIVATED"===e.type&&console.log("Background: pageâ€‘level mic permission is active")})),chrome.runtime.onMessage.addListener((function(r,n,t){if("latestNewQuery"===r.action){var o=r.data,s=o.searchQuery,c=o.isGoogle,a=o.isGoogleScholar,i=o.url,u={searchQuery:s,isGoogle:c,isGoogleScholar:a,isUsed:o.isUsed,dateAdded:o.dateAdded,url:i},l=c?"extractedGoogleQueryDetails":"extractedScholarQueryDetails";chrome.storage.local.set((d={},m=u,(g=function(r){var n=function(r){if("object"!=e(r)||!r)return r;var n=r[Symbol.toPrimitive];if(void 0!==n){var t=n.call(r,"string");if("object"!=e(t))return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(r)}(r);return"symbol"==e(n)?n:n+""}(g=l))in d?Object.defineProperty(d,g,{value:m,enumerable:!0,configurable:!0,writable:!0}):d[g]=m,d),(function(){chrome.runtime.lastError?console.error("Error storing query:",chrome.runtime.lastError):chrome.runtime.sendMessage({action:"newQueryAvailable",data:u})})),t({success:!0})}var d,g,m}));var s=new Map,c={tab:null};function a(e){return!!e&&""!==e.trim()&&!e.startsWith("chrome://extensions/")&&!e.startsWith("chrome://newtab/")}function i(){chrome.tabs.query({},(function(e){var r=new Map;e.forEach((function(e){e.url&&a(e.url)&&(r.has(e.url)||r.set(e.url,{url:e.url,title:e.title||"Untitled",favicon:e.favIconUrl||"icons/icon48.png",foundInStore:!1}))})),s.clear(),r.forEach((function(e,r){return s.set(r,e)})),chrome.runtime.sendMessage({type:"TABS_UPDATE",tabs:Array.from(s.values())}).catch((function(){}))}))}function u(){chrome.tabs.query({active:!0,currentWindow:!0},(function(e){var r=e[0];r&&r.url&&a(r.url)?c.tab={url:r.url,title:r.title||"Untitled",favicon:r.favIconUrl||"icons/icon48.png",foundInStore:!1}:c.tab={url:null,title:"There are no carriers or apps available...",favicon:"images/tabScreenshot.svg"},chrome.runtime.sendMessage({type:"CURRENT_TAB_UPDATE",tab:c.tab}).catch((function(){}))}))}Date.now(),chrome.tabs.onCreated.addListener((function(e){i(),e.active&&u(),Date.now()})),chrome.tabs.onUpdated.addListener((function(e,r,n){(r.url||r.title||r.favIconUrl)&&(i(),n.active&&u(),Date.now())})),chrome.tabs.onRemoved.addListener((function(){i(),u(),Date.now()})),chrome.tabs.onActivated.addListener((function(e){u(),Date.now()})),i(),u(),chrome.runtime.onMessage.addListener((function(e,r,n){return"GET_TABS"===e.type?n({tabs:Array.from(s.values())}):"GET_THE_CURRENT_TAB"===e.type&&n({tab:c.tab}),!0})),chrome.runtime.onMessage.addListener((function(e,r,n){"USER_LOGGED_IN"!==e.type&&"USER_LOGGED_OUT"!==e.type||chrome.runtime.sendMessage(e),n({success:!0})}));var l=!1;chrome.runtime.onMessage.addListener((function(e,n,o){if("loginWithGoogle"===e.action){if(l)return o({success:!1,error:"Authentication flow is already in progress."}),!0;l=!0,fetch("https://quicksearchserver-8ee1999baeab.herokuapp.com/api/auth/google/extension/start",{method:"GET"}).then((function(e){return e.json()})).then((function(e){var n=e.authUrl;chrome.identity.launchWebAuthFlow({url:n,interactive:!0},(function(e){if(l=!1,chrome.runtime.lastError)o({success:!1,error:chrome.runtime.lastError.message});else{var n=new URLSearchParams(new URL(e).search).get("code");fetch("https://quicksearchserver-8ee1999baeab.herokuapp.com/api/auth/google/extension/redirect?code=".concat(n),{method:"GET"}).then((function(e){return e.json()})).then(function(){var e=t(r().mark((function e(n){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.token&&n.refreshToken?chrome.runtime.sendMessage({action:"loginCompleted",token:n.token,refreshToken:n.refreshToken,user:n.user,tokenExpires:n.tokenExpires,isNewUser:n.isNewUser||!1}):"Google Authentication Failed"===n.message&&"Http Exception"===n.error?chrome.runtime.sendMessage({action:"needLoginViaEmailAndPassword",provider:"email"}):chrome.runtime.sendMessage({action:"loginFailed",error:"Failed to get tokens from server"});case 1:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}()).catch((function(e){console.error("Error fetching redirect URL:",e),o({success:!1,error:e.message})}))}}))})).catch((function(e){console.error("Error fetching OAuth start URL:",e),o({success:!1,error:e.message})}))}return!0})),chrome.runtime.onMessage.addListener((function(e,r,n){"FOLDERS_FETCHED"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"BOOKMARK_DETAILS_FETCHED"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"BACK_TO_HOME_SECTION"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"BACK_TO_CURRENT_TAB_SECTION"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"BACK_TO_ALL_TABS_SECTION"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"BACK_TO_GPT_SECTION"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"BACK_TO_DASHBOARD_SECTION"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"BACK_TO_PROFILE_SECTION"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"GET_STORED_DATA"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"USER_STATUS_FETCHED"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"GPT_STORED"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"BACK_TO_DASHBOARD_SECTION_COLLECTIONS"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"BACK_TO_DASHBOARD_SECTION_FAVORITES"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"BACK_TO_DASHBOARD_SECTION_LINKS"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"BACK_TO_DASHBOARD_SECTION_IMAGES"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"BACK_TO_DASHBOARD_SECTION_VIDEOS"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"BACK_TO_DASHBOARD_SECTION_ARTICLES"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"BACK_TO_DASHBOARD_SECTION_SETTINGS"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"BACK_TO_DASHBOARD_SECTION_HELPCENTER"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"BACK_TO_DASHBOARD_SECTION_CARD_DISPLAY"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"BACK_TO_DASHBOARD_SECTION_LIST_DISPLAY"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"DASHBOARD_COLLECTION_FOLDERS"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"DASHBOARD_COLLECTION_ANCESTOR_FOLDERS"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"DASHBOARD_COLLECTION_FOLDERS_BOOKMARKS"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"DASHBOARD_IMAGE_DETAIL"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"DASHBOARD_ARTICLE_DETAIL"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"DASHBOARD_VIDEO_DETAIL"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"ONBOARDING"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"OPEN_IN_NEW_TAB"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"SELECTED_BOOKMARK_PARENT_NAME"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"CHAT_GPT_USED"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"FETCH_STORED_GPT"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"BACK_TO_MAIN_GPT_SECTION"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"BACK_TO__GPT_TRANSLATE_SECTION"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"BACK_TO__GPT_OCR_SECTION"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"GPT_ACTIVE_DETAILS"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){"GET_GPT_DATA"===e.type&&chrome.runtime.sendMessage(e),n({success:!0})})),chrome.runtime.onMessage.addListener((function(e,r,n){var t;"downloadImage"===e.action&&(t=e.url,chrome.downloads.download({url:t,filename:undefined,saveAs:!0},(function(e){console.log("Download initiated with ID: ".concat(e))}))),n({success:!0})}));var d={show:!1,url:""},g={show:!1,url:""},m={show:!1,url:""},h={isRecording:!1,isPaused:!1,url:"",token:""},p=null,f=null,R=null,E=[],_=null,b=0,T=!1,O=null;function y(e){return[/meet\.google\.com\/.+/,/zoom\.us\/j\/.+/,/zoom\.us\/wc\/.+/,/app\.zoom\.us\/wc\/.+/,/teams\.microsoft\.com\/l\/meetup-join\/.+/,/teams\.microsoft\.com\/v2\/.+/,/teams\.live\.com\/v2\/.+/].some((function(r){return r.test(e.toLowerCase())}))}function M(){return A.apply(this,arguments)}function A(){return(A=t(r().mark((function e(){var n;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n="recorder.html",e.next=4,chrome.runtime.getContexts({});case 4:if(e.sent.some((function(e){return"OFFSCREEN_DOCUMENT"===e.contextType&&e.documentUrl.endsWith(n)}))){e.next=13;break}return console.log("Background: Creating offscreen document..."),e.next=10,chrome.offscreen.createDocument({url:n,reasons:["USER_MEDIA"],justification:"Recording audio from tab and microphone"});case 10:console.log("Background: Offscreen document created."),e.next=14;break;case 13:console.log("Background: Offscreen document already exists.");case 14:e.next=21;break;case 16:throw e.prev=16,e.t0=e.catch(0),console.error("background.js: Error setting up offscreen document:",e.t0),chrome.runtime.sendMessage({type:"RECORDING_ERROR",error:"Failed to create offscreen document: ".concat(e.t0.message)}),e.t0;case 21:case"end":return e.stop()}}),e,null,[[0,16]])})))).apply(this,arguments)}function S(e){return D.apply(this,arguments)}function D(){return(D=t(r().mark((function e(n){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!O||!h.isRecording){e.next=13;break}return e.prev=1,e.next=4,chrome.tabs.sendMessage(O,{type:n});case 4:console.log("background.js: Sent ".concat(n," to content script on tab ").concat(O)),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(1),console.error("background.js: Failed to send ".concat(n," to content script:"),e.t0),chrome.tabs.query({url:h.url},(function(e){e[0]&&e[0].id?(O=e[0].id,console.log("background.js: Updated activeTabId to ".concat(O," for URL ").concat(h.url)),chrome.tabs.sendMessage(O,{type:n},(function(){chrome.runtime.lastError?console.error("background.js: Failed to send ".concat(n," to updated tab ").concat(O,":"),chrome.runtime.lastError.message):console.log("background.js: Successfully sent ".concat(n," to updated tab ").concat(O))}))):console.error("background.js: No valid tab found for URL ".concat(h.url))}));case 11:e.next=14;break;case 13:console.log("background.js: Cannot send ".concat(n,", activeTabId: ").concat(O,", isRecording: ").concat(h.isRecording));case 14:case"end":return e.stop()}}),e,null,[[1,7]])})))).apply(this,arguments)}chrome.runtime.onMessage.addListener(function(){var e=t(r().mark((function e(n,o,s){var c,a,i,u,l,A,D,v,C,L,k,N,w,I,B,G,U,j,P,x,H;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("background.js: Received message:",n,"from sender:",o),e.t0=n.type,e.next="RECORDER_LOG"===e.t0?4:"MEETING_DETECTED"===e.t0?6:"SUMMARY_REQUESTED"===e.t0?8:"OVERLAY_CLOSED"===e.t0?12:"CONSENT_CONFIRMED"===e.t0?22:"CONSENT_CANCELLED"===e.t0?26:"SHOW_CONSENT_MODAL"===e.t0?43:"CHECK_MEETING_RECORD"===e.t0?47:"PENDING_CONSENT_AUTH"===e.t0?50:"SIDEBAR_OPENED"===e.t0?53:"SIDEBAR_CLOSED"===e.t0?57:"ACTIVATE_MICROPHONE"===e.t0?61:"START_RECORDING"===e.t0?63:"PAUSE_RECORDING"===e.t0?68:"RESUME_RECORDING"===e.t0?71:"SAVE_RECORDING"===e.t0?74:"downloadRecording"===e.t0?77:"recordingComplete"===e.t0?139:"RECORDING_ERROR"===e.t0?146:"SIDEBAR_READY"===e.t0?159:"AUTH_SUCCESS"===e.t0?163:166;break;case 4:return console.log("background.js: Forwarded from recorder.js: ".concat(n.message)),e.abrupt("break",166);case 6:return console.log("background.js: Meeting detected at: ".concat(n.url)),e.abrupt("break",166);case 8:return console.log("background.js: Meeting summary requested for: ".concat(n.url)),d={show:!0,url:n.url},chrome.runtime.sendMessage({type:"SHOW_CONSENT_MODAL",url:n.url}),e.abrupt("break",166);case 12:return console.log("background.js: Overlay closed for: ".concat(n.url)),d={show:!1,url:""},g={show:!1,url:""},m={show:!1,url:""},h.isRecording||(h={isRecording:!1,isPaused:!1,url:"",token:""},E=[],p&&clearTimeout(p),f&&clearTimeout(f),R&&clearTimeout(R),p=null,f=null,R=null),chrome.runtime.sendMessage({type:"CLOSE_CONSENT_MODAL"}),chrome.runtime.sendMessage({type:"CLOSE_RECORDER_MODAL"}),T=!1,O&&(chrome.tabs.sendMessage(O,{type:"SIDEBAR_STATE",isOpen:!1}),console.log("background.js: Sent SIDEBAR_STATE (closed) to content script")),e.abrupt("break",166);case 22:return console.log("background.js: Consent confirmed for meeting at: ".concat(n.url)),d={show:!1,url:""},chrome.tabs.query({active:!0,currentWindow:!0},(function(e){e[0]&&e[0].url&&e[0].url.includes(n.url)?(console.log("background.js: Active tab is meeting URL, sending SHOW_RECORDER_MODAL for: ".concat(n.url)),g={show:!0,url:n.url},chrome.runtime.sendMessage({type:"SHOW_RECORDER_MODAL",url:n.url})):(console.log("background.js: Active tab is not meeting URL, clearing pending states"),d={show:!1,url:""},g={show:!1,url:""},m={show:!1,url:""})})),e.abrupt("break",166);case 26:return console.log("background.js: Consent cancelled for meeting at: ".concat(n.url)),d={show:!1,url:""},g={show:!1,url:""},m={show:!1,url:""},h={isRecording:!1,isPaused:!1,url:"",token:""},E=[],p&&clearTimeout(p),f&&clearTimeout(f),R&&clearTimeout(R),p=null,f=null,R=null,chrome.runtime.sendMessage({type:"CLOSE_CONSENT_MODAL"}),chrome.runtime.sendMessage({type:"CLOSE_RECORDER_MODAL"}),T=!1,O&&(chrome.tabs.sendMessage(O,{type:"SIDEBAR_STATE",isOpen:!1}),console.log("background.js: Sent SIDEBAR_STATE (closed) to content script")),e.abrupt("break",166);case 43:return console.log("background.js: Received SHOW_CONSENT_MODAL for: ".concat(n.url)),d={show:!0,url:n.url},chrome.tabs.query({active:!0,currentWindow:!0},(function(e){e[0]&&e[0].url&&e[0].url.includes(n.url)?(console.log("background.js: Active tab is meeting URL, forwarding SHOW_CONSENT_MODAL"),chrome.runtime.sendMessage({type:"SHOW_CONSENT_MODAL",url:n.url})):(console.log("background.js: Active tab is not meeting URL, clearing pendingConsent"),d={show:!1,url:""})})),e.abrupt("break",166);case 47:return console.log("background.js: Received CHECK_MEETING_RECORD"),chrome.tabs.query({active:!0,currentWindow:!0},(function(e){e[0]&&e[0].url&&y(e[0].url)?(console.log("background.js: Active tab is meeting URL, sending SHOW_CONSENT_MODAL for: ".concat(e[0].url)),d={show:!0,url:e[0].url},chrome.runtime.sendMessage({type:"SHOW_CONSENT_MODAL",url:e[0].url})):console.log("background.js: Active tab is not a meeting URL")})),e.abrupt("break",166);case 50:return console.log("background.js: Received PENDING_CONSENT_AUTH for: ".concat(n.url)),m={show:!0,url:n.url},e.abrupt("break",166);case 53:return console.log("background.js: Received SIDEBAR_OPENED"),T=!0,O&&(chrome.tabs.sendMessage(O,{type:"SIDEBAR_STATE",isOpen:!0}),console.log("background.js: Sent SIDEBAR_STATE (opened) to content script")),e.abrupt("break",166);case 57:return console.log("background.js: Received SIDEBAR_CLOSED"),T=!1,O&&(chrome.tabs.sendMessage(O,{type:"SIDEBAR_STATE",isOpen:!1}),console.log("background.js: Sent SIDEBAR_STATE (closed) to content script")),e.abrupt("break",166);case 61:return chrome.tabs.query({active:!0,currentWindow:!0},(function(e){var r;null!==(r=e[0])&&void 0!==r&&r.id&&chrome.tabs.sendMessage(e[0].id,{type:"ACTIVATE_MICROPHONE"})})),e.abrupt("break",166);case 63:c=n.tabId,a=n.url,i=n.token,console.log("Background: START_RECORDING triggered for tab:",c),O=c;try{h={isRecording:!0,isPaused:!1,url:a,token:i},b=0,u=Math.floor(Date.now()/1e3),console.log("Background: Calling getMediaStreamId..."),chrome.tabCapture.getMediaStreamId({targetTabId:c},function(){var e=t(r().mark((function e(n){var t,o;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!chrome.runtime.lastError&&n){e.next=7;break}return o=(null===(t=chrome.runtime.lastError)||void 0===t?void 0:t.message)||"Unknown error getting media stream ID",console.error("Background: Failed to get media stream ID:",o),chrome.runtime.sendMessage({type:"RECORDING_ERROR",error:o}),O&&chrome.tabs.sendMessage(O,{type:"RECORDING_ERROR",error:o}),h={isRecording:!1,isPaused:!1,url:"",token:""},e.abrupt("return");case 7:return console.log("Background: Received streamId:",n),chrome.tabs.sendMessage(O,{type:"RECORDING_STARTED"}),console.log("background.js: Sent RECORDING_STARTED to content script"),e.next=12,M();case 12:console.log("Background: Sending startRecording message to offscreen document..."),chrome.runtime.sendMessage({target:"offscreen",type:"startRecording",data:{streamId:n,duration:18e4,token:i,totalPausedTime:b}}),chrome.storage.local.set({isMeetingRecording:!0,meetingUrl:a,sessionStartTime:u,totalElapsedTime:0,totalPausedTime:0,showRecorderModal:!0}),p&&clearTimeout(p),p=setTimeout((function(){chrome.runtime.sendMessage({target:"offscreen",type:"stopRecording"}),console.log("Background: Sent stop signal to offscreen after 3 minutes + paused time."),p=null}),18e4+b),f&&clearTimeout(f),f=setTimeout((function(){console.log("Background: Sending WARNING_2_MINUTES after 1 minute + paused time"),chrome.runtime.sendMessage({type:"WARNING_2_MINUTES"}),!T&&O&&S("WARNING_2_MINUTES"),f=null}),6e4+b),R&&clearTimeout(R),R=setTimeout((function(){console.log("Background: Sending WARNING_1_MINUTE after 2 minutes + paused time"),chrome.runtime.sendMessage({type:"WARNING_1_MINUTE"}),!T&&O&&S("WARNING_1_MINUTE"),R=null}),12e4+b);case 21:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}())}catch(e){console.error("Background: Error in startRecording flow:",e),chrome.runtime.sendMessage({type:"RECORDING_ERROR",error:e.message}),O&&chrome.tabs.sendMessage(O,{type:"RECORDING_ERROR",error:e.message}),h={isRecording:!1,isPaused:!1,url:"",token:""},chrome.storage.local.set({isMeetingRecording:!1,meetingUrl:"",sessionStartTime:0,totalElapsedTime:0,totalPausedTime:0}),p&&(clearTimeout(p),p=null),f&&(clearTimeout(f),f=null),R&&(clearTimeout(R),R=null)}return e.abrupt("break",166);case 68:return console.log("background.js: Received PAUSE_RECORDING for: ".concat(n.url)),h.isRecording&&!h.isPaused&&(h.isPaused=!0,_=Date.now(),console.log("Background: Pause started at:",_),chrome.runtime.sendMessage({target:"offscreen",type:"pauseRecording"}),console.log("Background: Sent pauseRecording to offscreen document."),f&&(clearTimeout(f),f=null,console.log("Background: Cleared warning2MinutesTimeout on pause.")),R&&(clearTimeout(R),R=null,console.log("Background: Cleared warning1MinuteTimeout on pause."))),e.abrupt("break",166);case 71:return console.log("background.js: Received RESUME_RECORDING for: ".concat(n.url)),h.isRecording&&h.isPaused&&(h.isPaused=!1,_&&(l=Date.now()-_,b+=l,console.log("Background: Resumed. Paused for:",l,"ms. Total paused time:",b,"ms"),chrome.storage.local.set({totalPausedTime:b},(function(){console.log("Background: Updated totalPausedTime in storage:",b)})),p&&clearTimeout(p),p=setTimeout((function(){chrome.runtime.sendMessage({target:"offscreen",type:"stopRecording"}),console.log("Background: Sent stop signal to offscreen after 3 minutes + paused time."),p=null}),18e4+b),f&&clearTimeout(f),f=setTimeout((function(){console.log("Background: Sending WARNING_2_MINUTES after 1 minute + paused time"),chrome.runtime.sendMessage({type:"WARNING_2_MINUTES"}),!T&&O&&S("WARNING_2_MINUTES"),f=null}),6e4+b),R&&clearTimeout(R),R=setTimeout((function(){console.log("Background: Sending WARNING_1_MINUTE after 2 minutes + paused time"),chrome.runtime.sendMessage({type:"WARNING_1_MINUTE"}),!T&&O&&S("WARNING_1_MINUTE"),R=null}),12e4+b),chrome.runtime.sendMessage({target:"offscreen",type:"updateRecordingTimeout",data:{duration:18e4,totalPausedTime:b}}),console.log("Background: Sent updateRecordingTimeout to offscreen with totalPausedTime:",b)),chrome.runtime.sendMessage({target:"offscreen",type:"resumeRecording"}),console.log("Background: Sent resumeRecording to offscreen document.")),e.abrupt("break",166);case 74:return console.log("background.js: Received SAVE_RECORDING for: ".concat(n.url)),h.isRecording&&(h={isRecording:!1,isPaused:!1,url:"",token:""},chrome.storage.local.set({isMeetingRecording:!1,meetingUrl:"",sessionStartTime:0,totalElapsedTime:0,totalPausedTime:0}),chrome.runtime.sendMessage({target:"offscreen",type:"stopRecording"}),console.log("Background: Sent stopRecording to offscreen document for save."),p&&clearTimeout(p),f&&clearTimeout(f),R&&clearTimeout(R),p=null,f=null,R=null,O&&chrome.tabs.sendMessage(O,{type:"SAVE_RECORDING"})),e.abrupt("break",166);case 77:if(A=n.base64,D=n.mimeType,v=n.filename,C=n.authToken,console.log("Background: Received downloadRecording request from offscreen document."),console.log("Background: Base64 string length:",A.length),"string"==typeof A&&0!==A.length){e.next=86;break}return L="Background: Received invalid or empty base64 string.",console.error(L,A),chrome.runtime.sendMessage({type:"RECORDING_ERROR",error:L}),O&&chrome.tabs.sendMessage(O,{type:"RECORDING_ERROR",error:L}),e.abrupt("return");case 86:if(e.prev=86,k=Uint8Array.from(atob(A),(function(e){return e.charCodeAt(0)})).buffer,console.log("Background: Converted base64 to ArrayBuffer. Size:",k.byteLength),N=new Blob([k],{type:D}),console.log("Background: Reconstructed Blob from ArrayBuffer. Size:",N.size,"Type:",N.type),0!==N.size){e.next=97;break}return w="Background: Reconstructed Blob is empty. No audio data to download.",console.error(w),chrome.runtime.sendMessage({type:"RECORDING_ERROR",error:w}),O&&chrome.tabs.sendMessage(O,{type:"RECORDING_ERROR",error:w}),e.abrupt("return");case 97:return(I=new FileReader).onloadend=t(r().mark((function e(){var n,t,o,s,c;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!I.result){e.next=27;break}if(n=I.result,console.log("Background: Converted Blob to Data URL (first 50 chars):",n.substring(0,50)+"..."),n.startsWith("data:audio/webm")){e.next=9;break}return t="Background: Invalid data URL format for audio/webm.",console.error(t),chrome.runtime.sendMessage({type:"RECORDING_ERROR",error:t}),O&&chrome.tabs.sendMessage(O,{type:"RECORDING_ERROR",error:t}),e.abrupt("return");case 9:return e.prev=9,e.next=12,chrome.downloads.download({url:n,filename:v,saveAs:!1});case 12:o=e.sent,console.log("Background: File download initiated. Download ID:",o),chrome.runtime.sendMessage({type:"recordingComplete"}),O&&chrome.tabs.sendMessage(O,{type:"recordingComplete"}),e.next=25;break;case 18:return e.prev=18,e.t0=e.catch(9),s="Background: Download failed: ".concat(e.t0.message),console.error(s),chrome.runtime.sendMessage({type:"RECORDING_ERROR",error:s}),O&&chrome.tabs.sendMessage(O,{type:"RECORDING_ERROR",error:s}),e.abrupt("return");case 25:e.next=32;break;case 27:return c="Background: FileReader result is null or empty.",console.error(c),chrome.runtime.sendMessage({type:"RECORDING_ERROR",error:c}),O&&chrome.tabs.sendMessage(O,{type:"RECORDING_ERROR",error:c}),e.abrupt("return");case 32:case"end":return e.stop()}}),e,null,[[9,18]])}))),I.onerror=function(e){var r="Background: FileReader error: ".concat(e.target.error.name);console.error(r),chrome.runtime.sendMessage({type:"RECORDING_ERROR",error:r}),O&&chrome.tabs.sendMessage(O,{type:"RECORDING_ERROR",error:r})},I.readAsDataURL(N),console.log("Background: Preparing to send audio to API..."),(B=new FormData).append("file",N,v),B.append("title","Meeting Recording ".concat((new Date).toISOString().slice(0,19).replace(/[:.]/g,"-"))),G=C,e.prev=106,e.next=109,fetch("http://localhost:3000/api/meetings/upload",{method:"POST",headers:{Authorization:"Bearer ".concat(G)},body:B});case 109:if((U=e.sent).ok){e.next=116;break}return j="Background: API request failed with status ".concat(U.status,": ").concat(U.statusText),console.error(j),chrome.runtime.sendMessage({type:"RECORDING_ERROR",error:j}),O&&chrome.tabs.sendMessage(O,{type:"RECORDING_ERROR",error:j}),e.abrupt("return");case 116:return e.next=118,U.json();case 118:P=e.sent,console.log("Background: API response:",P),chrome.runtime.sendMessage({type:"uploadComplete"}),chrome.storage.local.set({isMeetingRecording:!1,meetingUrl:"",sessionStartTime:0,totalElapsedTime:0}),e.next=130;break;case 124:e.prev=124,e.t1=e.catch(106),x="Background: API request error: ".concat(e.t1.message),console.error(x),chrome.runtime.sendMessage({type:"RECORDING_ERROR",error:x}),O&&chrome.tabs.sendMessage(O,{type:"RECORDING_ERROR",error:x});case 130:e.next=138;break;case 132:e.prev=132,e.t2=e.catch(86),H="Background: Error during download or API setup: ".concat(e.t2.message),console.error(H),chrome.runtime.sendMessage({type:"RECORDING_ERROR",error:H}),O&&chrome.tabs.sendMessage(O,{type:"RECORDING_ERROR",error:H});case 138:return e.abrupt("break",166);case 139:return p&&(clearTimeout(p),p=null),f&&(clearTimeout(f),f=null),R&&(clearTimeout(R),R=null),chrome.storage.local.set({isMeetingRecording:!1,meetingUrl:"",sessionStartTime:0,totalElapsedTime:0,totalPausedTime:0}),chrome.runtime.sendMessage({type:"recordingComplete"}),O&&chrome.tabs.sendMessage(O,{type:"recordingComplete"}),e.abrupt("break",166);case 146:return console.log("background.js: Received RECORDING_ERROR: ".concat(n.error)),h={isRecording:!1,isPaused:!1,url:"",token:""},chrome.storage.local.set({isMeetingRecording:!1,meetingUrl:"",sessionStartTime:0,totalElapsedTime:0,totalPausedTime:0}),E=[],p&&clearTimeout(p),f&&clearTimeout(f),R&&clearTimeout(R),p=null,f=null,R=null,chrome.runtime.sendMessage({type:"RECORDING_ERROR",error:n.error}),O&&chrome.tabs.sendMessage(O,{type:"RECORDING_ERROR",error:n.error}),e.abrupt("break",166);case 159:return console.log("background.js: Received SIDEBAR_READY"),T=!0,chrome.tabs.query({active:!0,currentWindow:!0},(function(e){if(e[0]&&e[0].url){O=e[0].id;var r=y(e[0].url);console.log("background.js: Sending TAB_UPDATED for: ".concat(e[0].url,", isMeeting: ").concat(r)),chrome.runtime.sendMessage({type:"TAB_UPDATED",url:e[0].url,isMeeting:r}),O&&(chrome.tabs.sendMessage(O,{type:"SIDEBAR_STATE",isOpen:!0}),console.log("background.js: Sent SIDEBAR_STATE (opened) to content script")),d.show&&e[0].url.includes(d.url)?(console.log("background.js: Active tab is meeting URL, sending SHOW_CONSENT_MODAL for: ".concat(d.url)),chrome.runtime.sendMessage({type:"SHOW_CONSENT_MODAL",url:d.url})):d.show&&(console.log("background.js: Active tab is not meeting URL, clearing pendingConsent"),d={show:!1,url:""}),g.show&&e[0].url.includes(g.url)?(console.log("background.js: Active tab is meeting URL, sending SHOW_RECORDER_MODAL for: ".concat(g.url)),chrome.runtime.sendMessage({type:"SHOW_RECORDER_MODAL",url:g.url})):g.show&&(console.log("background.js: Active tab is not meeting URL, clearing pendingRecorderModal"),g={show:!1,url:""})}})),e.abrupt("break",166);case 163:return console.log("background.js: Received AUTH_SUCCESS"),m.show&&chrome.tabs.query({active:!0,currentWindow:!0},(function(e){e[0]&&e[0].url&&e[0].url.includes(m.url)?(console.log("background.js: Active tab is meeting URL, sending SHOW_RECORDER_MODAL for: ".concat(m.url)),g={show:!0,url:m.url},m={show:!1,url:""},chrome.runtime.sendMessage({type:"SHOW_RECORDER_MODAL",url:g.url})):(console.log("background.js: Active tab is not meeting URL, clearing pendingAuthConsent"),m={show:!1,url:""})})),e.abrupt("break",166);case 166:return e.abrupt("return",!0);case 167:case"end":return e.stop()}}),e,null,[[86,132],[106,124]])})));return function(r,n,t){return e.apply(this,arguments)}}()),chrome.tabs.onActivated.addListener((function(e){console.log("background.js: Tab activated: ".concat(e.tabId)),O=e.tabId,chrome.tabs.query({active:!0,currentWindow:!0},(function(e){if(e[0]&&e[0].url){var r=y(e[0].url);console.log("background.js: Sending TAB_UPDATED for: ".concat(e[0].url,", isMeeting: ").concat(r)),chrome.runtime.sendMessage({type:"TAB_UPDATED",url:e[0].url,isMeeting:r}),O&&(chrome.tabs.sendMessage(O,{type:"SIDEBAR_STATE",isOpen:T}),console.log("background.js: Sent SIDEBAR_STATE to content script on tab activation"))}!d.show||e[0]&&e[0].url&&e[0].url.includes(d.url)||(console.log("background.js: Active tab changed, no longer meeting URL, sending CLOSE_CONSENT_MODAL"),d={show:!1,url:""},chrome.runtime.sendMessage({type:"CLOSE_CONSENT_MODAL"})),!g.show||e[0]&&e[0].url&&e[0].url.includes(g.url)||(console.log("background.js: Active tab changed, no longer meeting URL, sending CLOSE_RECORDER_MODAL"),h.isRecording&&E.length>0&&new Blob(E,{type:"audio/webm;codecs=opus"}).size>1024&&(console.log("background.js: Recording >1KB on tab change, stopping and uploading"),chrome.runtime.sendMessage({target:"offscreen",type:"stopRecording"})),h={isRecording:!1,isPaused:!1,url:"",token:""},g={show:!1,url:""},p&&clearTimeout(p),f&&clearTimeout(f),R&&clearTimeout(R),p=null,f=null,R=null,chrome.runtime.sendMessage({type:"CLOSE_RECORDER_MODAL"}),T=!1,O&&(chrome.tabs.sendMessage(O,{type:"SIDEBAR_STATE",isOpen:!1}),console.log("background.js: Sent SIDEBAR_STATE (closed) to content script"))),!m.show||e[0]&&e[0].url&&e[0].url.includes(m.url)||(console.log("background.js: Active tab changed, no longer meeting URL, clearing pendingAuthConsent"),m={show:!1,url:""})}))})),chrome.tabs.onUpdated.addListener((function(e,r,n){if(n.url&&r.url){var t=y(n.url);console.log("background.js: Sending TAB_UPDATED for: ".concat(n.url,", isMeeting: ").concat(t)),chrome.runtime.sendMessage({type:"TAB_UPDATED",url:n.url,isMeeting:t})}d.show&&r.url&&n.url&&!n.url.includes(d.url)&&(console.log("background.js: Meeting tab URL changed, sending CLOSE_CONSENT_MODAL"),d={show:!1,url:""},chrome.runtime.sendMessage({type:"CLOSE_CONSENT_MODAL"})),g.show&&r.url&&n.url&&!n.url.includes(g.url)&&(console.log("background.js: Meeting tab URL changed, sending CLOSE_RECORDER_MODAL"),h.isRecording&&E.length>0&&new Blob(E,{type:"audio/webm;codecs=opus"}).size>1024&&(console.log("background.js: Recording >1KB on tab URL change, stopping and uploading"),chrome.runtime.sendMessage({target:"offscreen",type:"stopRecording"})),h={isRecording:!1,isPaused:!1,url:"",token:""},g={show:!1,url:""},p&&clearTimeout(p),f&&clearTimeout(f),R&&clearTimeout(R),p=null,f=null,R=null,chrome.runtime.sendMessage({type:"CLOSE_RECORDER_MODAL"}),T=!1,O&&(chrome.tabs.sendMessage(O,{type:"SIDEBAR_STATE",isOpen:!1}),console.log("background.js: Sent SIDEBAR_STATE (closed) to content script"))),m.show&&r.url&&n.url&&!n.url.includes(m.url)&&(console.log("background.js: Meeting tab URL changed, clearing pendingAuthConsent"),m={show:!1,url:""})})),chrome.tabs.onRemoved.addListener((function(e,r){d.show&&chrome.tabs.query({},(function(e){e.find((function(e){return e.url&&e.url.includes(d.url)}))||(console.log("background.js: Meeting tab closed, sending CLOSE_CONSENT_MODAL"),d={show:!1,url:""},chrome.runtime.sendMessage({type:"CLOSE_CONSENT_MODAL"}))})),g.show&&chrome.tabs.query({},(function(e){e.find((function(e){return e.url&&e.url.includes(g.url)}))||(console.log("background.js: Meeting tab closed, sending CLOSE_RECORDER_MODAL"),h.isRecording&&E.length>0&&new Blob(E,{type:"audio/webm;codecs=opus"}).size>1024&&(console.log("background.js: Recording >1KB on tab close, stopping and uploading"),chrome.runtime.sendMessage({target:"offscreen",type:"stopRecording"})),h={isRecording:!1,isPaused:!1,url:"",token:""},g={show:!1,url:""},p&&clearTimeout(p),f&&clearTimeout(f),R&&clearTimeout(R),p=null,f=null,R=null,chrome.runtime.sendMessage({type:"CLOSE_RECORDER_MODAL"}),T=!1,O&&(chrome.tabs.sendMessage(O,{type:"SIDEBAR_STATE",isOpen:!1}),console.log("background.js: Sent SIDEBAR_STATE (closed) to content script")))})),m.show&&chrome.tabs.query({},(function(e){e.find((function(e){return e.url&&e.url.includes(m.url)}))||(console.log("background.js: Meeting tab closed, clearing pendingAuthConsent"),m={show:!1,url:""})}))})),setInterval((function(){chrome.tabs.query({active:!0,currentWindow:!0},(function(e){e[0]&&e[0].id&&e[0].url&&y(e[0].url)?(O=e[0].id,chrome.tabs.sendMessage(e[0].id,{type:"CHECK_MEETING"},(function(e){chrome.runtime.lastError?console.error("background.js: Failed to send CHECK_MEETING: ".concat(chrome.runtime.lastError.message)):console.log("background.js: CHECK_MEETING response:",e)}))):console.log("background.js: No valid meeting tab for CHECK_MEETING")}))}),3e4)})();