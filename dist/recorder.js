/*! For license information please see recorder.js.LICENSE.txt */
(()=>{"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(){t=function(){return o};var r,o={},n=Object.prototype,a=n.hasOwnProperty,c=Object.defineProperty||function(e,t,r){e[t]=r.value},i="function"==typeof Symbol?Symbol:{},s=i.iterator||"@@iterator",l=i.asyncIterator||"@@asyncIterator",u=i.toStringTag||"@@toStringTag";function f(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{f({},"")}catch(r){f=function(e,t,r){return e[t]=r}}function d(e,t,r,o){var n=t&&t.prototype instanceof b?t:b,a=Object.create(n.prototype),i=new _(o||[]);return c(a,"_invoke",{value:x(e,r,i)}),a}function g(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}o.wrap=d;var p="suspendedStart",h="suspendedYield",m="executing",v="completed",y={};function b(){}function O(){}function R(){}var w={};f(w,s,(function(){return this}));var E=Object.getPrototypeOf,M=E&&E(E(P([])));M&&M!==n&&a.call(M,s)&&(w=M);var k=R.prototype=b.prototype=Object.create(w);function T(e){["next","throw","return"].forEach((function(t){f(e,t,(function(e){return this._invoke(t,e)}))}))}function S(t,r){function o(n,c,i,s){var l=g(t[n],t,c);if("throw"!==l.type){var u=l.arg,f=u.value;return f&&"object"==e(f)&&a.call(f,"__await")?r.resolve(f.__await).then((function(e){o("next",e,i,s)}),(function(e){o("throw",e,i,s)})):r.resolve(f).then((function(e){u.value=e,i(u)}),(function(e){return o("throw",e,i,s)}))}s(l.arg)}var n;c(this,"_invoke",{value:function(e,t){function a(){return new r((function(r,n){o(e,t,r,n)}))}return n=n?n.then(a,a):a()}})}function x(e,t,o){var n=p;return function(a,c){if(n===m)throw Error("Generator is already running");if(n===v){if("throw"===a)throw c;return{value:r,done:!0}}for(o.method=a,o.arg=c;;){var i=o.delegate;if(i){var s=L(i,o);if(s){if(s===y)continue;return s}}if("next"===o.method)o.sent=o._sent=o.arg;else if("throw"===o.method){if(n===p)throw n=v,o.arg;o.dispatchException(o.arg)}else"return"===o.method&&o.abrupt("return",o.arg);n=m;var l=g(e,t,o);if("normal"===l.type){if(n=o.done?v:h,l.arg===y)continue;return{value:l.arg,done:o.done}}"throw"===l.type&&(n=v,o.method="throw",o.arg=l.arg)}}}function L(e,t){var o=t.method,n=e.iterator[o];if(n===r)return t.delegate=null,"throw"===o&&e.iterator.return&&(t.method="return",t.arg=r,L(e,t),"throw"===t.method)||"return"!==o&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+o+"' method")),y;var a=g(n,e.iterator,t.arg);if("throw"===a.type)return t.method="throw",t.arg=a.arg,t.delegate=null,y;var c=a.arg;return c?c.done?(t[e.resultName]=c.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=r),t.delegate=null,y):c:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,y)}function C(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function D(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(C,this),this.reset(!0)}function P(t){if(t||""===t){var o=t[s];if(o)return o.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,c=function e(){for(;++n<t.length;)if(a.call(t,n))return e.value=t[n],e.done=!1,e;return e.value=r,e.done=!0,e};return c.next=c}}throw new TypeError(e(t)+" is not iterable")}return O.prototype=R,c(k,"constructor",{value:R,configurable:!0}),c(R,"constructor",{value:O,configurable:!0}),O.displayName=f(R,u,"GeneratorFunction"),o.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===O||"GeneratorFunction"===(t.displayName||t.name))},o.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,R):(e.__proto__=R,f(e,u,"GeneratorFunction")),e.prototype=Object.create(k),e},o.awrap=function(e){return{__await:e}},T(S.prototype),f(S.prototype,l,(function(){return this})),o.AsyncIterator=S,o.async=function(e,t,r,n,a){void 0===a&&(a=Promise);var c=new S(d(e,t,r,n),a);return o.isGeneratorFunction(t)?c:c.next().then((function(e){return e.done?e.value:c.next()}))},T(k),f(k,u,"Generator"),f(k,s,(function(){return this})),f(k,"toString",(function(){return"[object Generator]"})),o.keys=function(e){var t=Object(e),r=[];for(var o in t)r.push(o);return r.reverse(),function e(){for(;r.length;){var o=r.pop();if(o in t)return e.value=o,e.done=!1,e}return e.done=!0,e}},o.values=P,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=r,this.done=!1,this.delegate=null,this.method="next",this.arg=r,this.tryEntries.forEach(D),!e)for(var t in this)"t"===t.charAt(0)&&a.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=r)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function o(o,n){return i.type="throw",i.arg=e,t.next=o,n&&(t.method="next",t.arg=r),!!n}for(var n=this.tryEntries.length-1;n>=0;--n){var c=this.tryEntries[n],i=c.completion;if("root"===c.tryLoc)return o("end");if(c.tryLoc<=this.prev){var s=a.call(c,"catchLoc"),l=a.call(c,"finallyLoc");if(s&&l){if(this.prev<c.catchLoc)return o(c.catchLoc,!0);if(this.prev<c.finallyLoc)return o(c.finallyLoc)}else if(s){if(this.prev<c.catchLoc)return o(c.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<c.finallyLoc)return o(c.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&a.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var n=o;break}}n&&("break"===e||"continue"===e)&&n.tryLoc<=t&&t<=n.finallyLoc&&(n=null);var c=n?n.completion:{};return c.type=e,c.arg=t,n?(this.method="next",this.next=n.finallyLoc,y):this.complete(c)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),y},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),D(r),y}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var o=r.completion;if("throw"===o.type){var n=o.arg;D(r)}return n}}throw Error("illegal catch attempt")},delegateYield:function(e,t,o){return this.delegate={iterator:P(e),resultName:t,nextLoc:o},"next"===this.method&&(this.arg=r),y}},o}function r(e,t,r,o,n,a,c){try{var i=e[a](c),s=i.value}catch(e){return void r(e)}i.done?t(s):Promise.resolve(s).then(o,n)}function o(e){return function(){var t=this,o=arguments;return new Promise((function(n,a){var c=e.apply(t,o);function i(e){r(c,n,a,i,s,"next",e)}function s(e){r(c,n,a,i,s,"throw",e)}i(void 0)}))}}var n,a,c,i,s,l;console.log("Offscreen: recorder.js script loaded.");var u=null;document.addEventListener("DOMContentLoaded",(function(){if(console.log("Offscreen: DOMContentLoaded event fired. Recorder script is ready."),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return console.error("Offscreen: navigator.mediaDevices.getUserMedia is not available in this context."),void chrome.runtime.sendMessage({type:"RECORDING_ERROR",error:"MediaDevices API not available in offscreen document."});console.log("Offscreen: navigator.mediaDevices.getUserMedia is available."),chrome.runtime.onMessage.addListener(function(){var e=o(t().mark((function e(r){var f,d,g,p,h,m,v,y,b,O,R,w,E,M,k,T,S;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("offscreen"===r.target){e.next=2;break}return e.abrupt("return");case 2:if(console.log("Offscreen: Received message:",r.type),"startRecording"!==r.type){e.next=111;break}return f=r.data,d=f.streamId,g=f.duration,p=f.token,h=f.totalPausedTime,console.log("Offscreen: Handling startRecording message with streamId:",d),console.log("Offscreen: Recording duration set to:",g,"milliseconds"),console.log("Offscreen: Initial totalPausedTime:",h),console.log("Offscreen: Token from background.js",p),n&&"inactive"!==n.state&&(console.warn("Offscreen: Stopping previous recorder before starting new one."),n.stop(),c&&c.getTracks().forEach((function(e){return e.stop()})),l&&l.getTracks().forEach((function(e){return e.stop()})),i&&i.close()),a=[],console.log("Offscreen: Attempting to get tab audio with streamId:",d),e.next=14,navigator.mediaDevices.getUserMedia({audio:{mandatory:{chromeMediaSource:"tab",chromeMediaSourceId:d}}});case 14:return c=e.sent,console.log("Offscreen: Successfully got tab MediaStream:",c),e.prev=16,console.log("Offscreen: Waiting 500ms before requesting microphone access..."),e.next=20,new Promise((function(e){return setTimeout(e,500)}));case 20:return console.log("Offscreen: Attempting to get microphone audio..."),e.prev=21,e.next=24,navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});case 24:l=e.sent,console.log("Offscreen: Successfully got microphone MediaStream:",l),e.next=32;break;case 28:throw e.prev=28,e.t0=e.catch(21),console.error("Offscreen: Microphone access failed:",e.t0.name,e.t0.message),e.t0;case 32:if(console.log("Offscreen: Creating AudioContext..."),i=new AudioContext,m=i.createMediaStreamDestination(),(s=i.createMediaStreamSource(c)).connect(m),console.log("Offscreen: Tab audio connected to recording destination."),v=i.destination,s.connect(v),console.log("Offscreen: Tab audio connected to speaker output for playback."),i.createMediaStreamSource(l).connect(m),console.log("Offscreen: Microphone audio connected to recording destination."),y=m.stream,console.log("Offscreen: Combined MediaStream created with",y.getAudioTracks().length,"audio tracks."),!((b=y.getAudioTracks()).length>0)){e.next=59;break}if(console.log("Offscreen: Combined stream audio track state:",{enabled:b[0].enabled,muted:b[0].muted,readyState:b[0].readyState}),b[0].enabled&&!b[0].muted&&"live"===b[0].readyState){e.next=57;break}return O="Combined audio track is not ready or is muted/disabled. Please ensure audio is active.",console.error(O),chrome.runtime.sendMessage({type:"RECORDING_ERROR",error:O}),c&&c.getTracks().forEach((function(e){return e.stop()})),l&&l.getTracks().forEach((function(e){return e.stop()})),i&&i.close(),e.abrupt("return");case 57:e.next=66;break;case 59:return R="Combined MediaStream has no audio tracks. Cannot record.",console.error(R),chrome.runtime.sendMessage({type:"RECORDING_ERROR",error:R}),c&&c.getTracks().forEach((function(e){return e.stop()})),l&&l.getTracks().forEach((function(e){return e.stop()})),i&&i.close(),e.abrupt("return");case 66:if(w="audio/webm;codecs=opus",MediaRecorder.isTypeSupported(w)){e.next=77;break}return E="MediaRecorder does not support ".concat(w,"."),console.error(E),chrome.runtime.sendMessage({type:"RECORDING_ERROR",error:E}),c&&c.getTracks().forEach((function(e){return e.stop()})),l&&l.getTracks().forEach((function(e){return e.stop()})),i&&i.close(),e.abrupt("return");case 77:console.log("Offscreen: MediaRecorder supports ".concat(w,"."));case 78:n=new MediaRecorder(y,{mimeType:w}),console.log("Offscreen: MediaRecorder created for combined stream. Initial state:",n.state),n.ondataavailable=function(e){e.data&&e.data.size>0?a.push(e.data):console.warn("Offscreen: ondataavailable event received, but data is empty or null.")},n.onstart=function(){console.log("Offscreen: MediaRecorder STARTED. State:",n.state)},n.onpause=function(){console.log("Offscreen: MediaRecorder PAUSED. State:",n.state)},n.onresume=function(){console.log("Offscreen: MediaRecorder RESUMED. State:",n.state)},n.onstop=o(t().mark((function e(){var r,o,u;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("Offscreen: MediaRecorder STOPPED. Final state:",n.state),c&&(c.getTracks().forEach((function(e){return e.stop()})),console.log("Offscreen: Tab MediaStream tracks stopped.")),l&&(l.getTracks().forEach((function(e){return e.stop()})),console.log("Offscreen: Microphone MediaStream tracks stopped.")),i&&(i.close(),console.log("Offscreen: AudioContext closed.")),console.log("Offscreen: recordedBlobs array length before Blob creation:",a.length),a.length>0&&(console.log("Offscreen: First recordedBlob size:",a[0].size),console.log("Offscreen: Last recordedBlob size:",a[a.length-1].size)),0!==a.length){e.next=10;break}return console.warn("Offscreen: No audio data was collected. Recorded Blobs length is 0."),chrome.runtime.sendMessage({type:"RECORDING_ERROR",error:"No audio data captured."}),e.abrupt("return");case 10:return r="audio/webm;codecs=opus",o=new Blob(a,{type:r}),console.log("Offscreen: Created Blob:",o),console.log("Offscreen: Converting Blob to base64 string."),e.next=16,new Promise((function(e,t){var r=new FileReader;r.onloadend=function(){if(r.result){var o=r.result.split(",")[1];console.log("Offscreen: Base64 string length:",o.length),e(o)}else t(new Error("FileReader result is null or empty."))},r.onerror=function(){return t(new Error("FileReader error: ".concat(r.error.name)))},r.readAsDataURL(o)}));case 16:return u=e.sent,console.log("Offscreen: Sending base64 string to background script for download."),e.prev=18,e.next=21,chrome.runtime.sendMessage({type:"downloadRecording",base64:u,mimeType:r,filename:"recording-".concat((new Date).toISOString().slice(0,19).replace(/[:.]/g,"-"),".webm"),authToken:p});case 21:console.log("Offscreen: Successfully sent base64 string to background script."),e.next=28;break;case 24:e.prev=24,e.t0=e.catch(18),console.error("Offscreen: Error sending base64 string to background script:",e.t0),chrome.runtime.sendMessage({type:"RECORDING_ERROR",error:"Failed to send recording: ".concat(e.t0.message)});case 28:console.log("Offscreen: Cleaning up recorder state variables."),a=null,n=null,c=null,l=null,i=null,s=null;case 36:case"end":return e.stop()}}),e,null,[[18,24]])}))),n.onerror=function(e){console.error("Offscreen: MediaRecorder ERROR:",e.error),chrome.runtime.sendMessage({type:"RECORDING_ERROR",error:"MediaRecorder error: ".concat(e.error.name)}),c&&c.getTracks().forEach((function(e){return e.stop()})),l&&l.getTracks().forEach((function(e){return e.stop()})),i&&i.close(),a=null,n=null,c=null,l=null,i=null,s=null},n.start(10),console.log("Offscreen: MediaRecorder start() called. Current state:",n.state),u&&clearTimeout(u),u=setTimeout((function(){n&&"recording"===n.state?(console.log("Offscreen: Timeout reached. Stopping MediaRecorder."),n.stop()):console.log("Offscreen: Timeout reached, but MediaRecorder not in 'recording' state (current state: "+(n?n.state:"null")+").")}),g+h),console.log("Offscreen: Set recording timeout for",g+h,"ms"),e.next=109;break;case 93:return e.prev=93,e.t1=e.catch(16),M="NotAllowedError"===e.t1.name?"Microphone permission was denied. Please grant permission to record all voices.":"NotFoundError"===e.t1.name?"No microphone found. Please connect a microphone and try again.":"Recording setup failed: ".concat(e.t1.message),console.error("Offscreen: ",M),chrome.runtime.sendMessage({type:"RECORDING_ERROR",error:M}),c&&c.getTracks().forEach((function(e){return e.stop()})),l&&l.getTracks().forEach((function(e){return e.stop()})),i&&i.close(),a=null,n=null,c=null,l=null,i=null,s=null,e.abrupt("return");case 109:e.next=112;break;case 111:"stopRecording"===r.type?(console.log("Offscreen: Received stopRecording message."),n&&"recording"===n.state&&(n.stop(),console.log("Offscreen: MediaRecorder manually stopped.")),u&&(clearTimeout(u),u=null,console.log("Offscreen: Cleared recording timeout on stop."))):"pauseRecording"===r.type?(console.log("Offscreen: Received pauseRecording message."),n&&"recording"===n.state&&(n.pause(),console.log("Offscreen: MediaRecorder paused."),u&&(clearTimeout(u),u=null,console.log("Offscreen: Cleared recording timeout on pause.")))):"resumeRecording"===r.type?(console.log("Offscreen: Received resumeRecording message."),n&&"paused"===n.state&&(n.resume(),console.log("Offscreen: MediaRecorder resumed."))):"updateRecordingTimeout"===r.type&&(k=r.data,T=k.duration,S=k.totalPausedTime,console.log("Offscreen: Received updateRecordingTimeout with duration:",T,"totalPausedTime:",S),n&&"recording"===n.state?(u&&clearTimeout(u),u=setTimeout((function(){n&&"recording"===n.state?(console.log("OffOffscreen: Updated timeout reached. Stopping MediaRecorder."),n.stop()):console.log("Offscreen: Updated timeout reached, but MediaRecorder not in 'recording' state (current state: "+(n?n.state:"null")+").")}),T+S),console.log("Offscreen: Set updated recording timeout for",T+S,"ms")):console.warn("Offscreen: Received updateRecordingTimeout but MediaRecorder is not recording. State:",n?n.state:"null"));case 112:case"end":return e.stop()}}),e,null,[[16,93],[21,28]])})));return function(t){return e.apply(this,arguments)}}())}))})();